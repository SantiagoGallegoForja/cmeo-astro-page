<!DOCTYPE html>                                                                                                                 
  <html lang="es">                                                                                                                
                                                                                                                                  
  <head>                                                                                                                          
    <meta charset="UTF-8" />                                                                                                      
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />                                                      
    <title>Lista de Minas | SBGA</title>                                                                                          
    <script src="https://cdn.tailwindcss.com"></script>                                                                           
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>                                                           
    <style>                                                                                                                       
      .btn-page[disabled] { opacity: 0.5; cursor: not-allowed; }                                                                  
      .modal-overlay { background: rgba(0,0,0,0.5); }                                                                             
    </style>                                                                                                                      
  </head>                                                                                                                         
                                                                                                                                  
  <body class="bg-gray-100">                                                                                                      
                                                                                                                                  
    <div class="flex min-h-screen">                                                                                               
      <!-- Loader -->                                                                                                             
      <div id="loader" class="fixed inset-0 flex justify-center items-center bg-white bg-opacity-70 z-20">                        
        <div class="flex flex-col items-center gap-2">                                                                            
          <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">   
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>                    
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>                          
          </svg>                                                                                                                  
          <p class="text-sm text-gray-600">Cargando minas...</p>                                                                  
        </div>                                                                                                                    
      </div>                                                                                                                      
                                                                                                                                  
      <!-- Sidebar -->                                                                                                            
      <div id="sidebar-container">                                                                                                
        [wpcode id="8942"]                                                                                                        
      </div>                                                                                                                      
                                                                                                                                  
      <!-- Contenido -->                                                                                                          
      <div class="p-6 md:p-8 w-full">                                                                                             
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">                                     
          <h1 class="text-2xl font-bold text-gray-800">Minas</h1>                                                                 
                                                                                                                                  
          <div class="flex flex-col sm:flex-row gap-3 sm:items-center">                                                           
            <!-- Bot√≥n Agregar -->                                                                                                
            <button id="btnAgregarMina" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex           
  items-center gap-2">                                                                                                            
              <span>+</span> Nueva Mina                                                                                           
            </button>                                                                                                             
                                                                                                                                  
            <div class="relative">                                                                                                
              <input type="text" id="filtroGlobal" placeholder="Buscar en todos los campos..."                                    
                class="w-full sm:w-80 border px-4 py-2 rounded shadow-sm" />                                                      
              <span class="absolute right-3 top-2.5 text-gray-400 pointer-events-none">üîç</span>                                  
            </div>                                                                                                                
                                                                                                                                  
            <div class="flex items-center gap-2">                                                                                 
              <label for="pageSize" class="text-sm text-gray-600">Filas por p√°gina</label>                                        
              <select id="pageSize" class="border px-3 py-2 rounded shadow-sm">                                                   
                <option value="10">10</option>                                                                                    
                <option value="25">25</option>                                                                                    
                <option value="50" selected>50</option>                                                                           
                <option value="100">100</option>                                                                                  
              </select>                                                                                                           
            </div>                                                                                                                
          </div>                                                                                                                  
        </div>                                                                                                                    
                                                                                                                                  
        <div class="bg-white shadow rounded-lg overflow-x-auto">                                                                  
          <table class="min-w-full text-sm text-left text-gray-700">                                                              
            <thead class="bg-gray-100">                                                                                           
              <tr>                                                                                                                
                <th class="px-4 py-3">Nombre</th>                                                                                 
                <th class="px-4 py-3">Categor√≠a</th>                                                                              
                <th class="px-4 py-3">Pa√≠s</th>                                                                                   
                <th class="px-4 py-3">Creado</th>                                                                                 
                <th class="px-4 py-3">√öltima actualizaci√≥n</th>                                                                   
                <th class="px-4 py-3">Estado</th>                                                                                 
                <th class="px-4 py-3 text-center">Acciones</th>                                                                   
              </tr>                                                                                                               
            </thead>                                                                                                              
            <tbody id="tablaMinas"></tbody>                                                                                       
          </table>                                                                                                                
        </div>                                                                                                                    
                                                                                                                                  
        <!-- Footer de tabla -->                                                                                                  
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4">                                     
          <div id="rangeInfo" class="text-sm text-gray-600">Mostrando 0‚Äì0 de 0</div>                                              
          <div id="pagination" class="flex flex-wrap items-center gap-1"></div>                                                   
        </div>                                                                                                                    
      </div>                                                                                                                      
    </div>                                                                                                                        
                                                                                                                                  
    <!-- Modal Crear/Editar -->                                                                                                   
    <div id="modalMina" class="fixed inset-0 z-50 hidden">                                                                        
      <div class="modal-overlay absolute inset-0" onclick="cerrarModal()"></div>                                                  
      <div class="relative z-10 flex items-center justify-center min-h-screen p-4">                                               
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">                                                           
          <div class="flex justify-between items-center mb-4">                                                                    
            <h2 id="modalTitulo" class="text-xl font-bold text-gray-800">Nueva Mina</h2>                                          
            <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>                   
          </div>                                                                                                                  
                                                                                                                                  
          <form id="formMina">                                                                                                    
            <input type="hidden" id="minaId" />                                                                                   
            <input type="hidden" id="modoEdicion" value="false" />                                                                
                                                                                                                                  
            <div class="mb-4">                                                                                                    
              <label class="block text-sm font-semibold mb-1">Nombre de la mina</label>                                           
              <input type="text" id="minaNombre" required                                                                         
                class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"                       
                placeholder="Ej: Mina El Dorado" />                                                                               
            </div>                                                                                                                
                                                                                                                                  
            <div class="mb-6">                                                                                                    
              <label class="block text-sm font-semibold mb-1">Pa√≠s</label>                                                        
              <select id="minaPais" required                                                                                      
                class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">                      
                <option value="">Seleccione un pa√≠s</option>                                                                      
                <option value="CO">Colombia</option>                                                                              
                <option value="PE">Per√∫</option>                                                                                  
              </select>                                                                                                           
            </div>                                                                                                                
                                                                                                                                  
            <div class="flex gap-3 justify-end">                                                                                  
              <button type="button" onclick="cerrarModal()"                                                                       
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">                                            
                Cancelar                                                                                                          
              </button>                                                                                                           
              <button type="submit" id="btnGuardarMina"                                                                           
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">                                               
                Guardar                                                                                                           
              </button>                                                                                                           
            </div>                                                                                                                
          </form>                                                                                                                 
        </div>                                                                                                                    
      </div>                                                                                                                      
    </div>                                                                                                                        
                                                                                                                                  
    [wpcode id="10843"]                                                                                                           
                                                                                                                                  
    <script>                                                                                                                      
      const GAS_URL =                                                                                                             
  "https://script.google.com/macros/s/AKfycbwrqoyq40zHZ4ESTSRSaknEy0-calbBxLfmpKJZ4GruiQQKSxRCfjAgfC6QO1QqBrkH/exec";             
                                                                                                                                  
      let DATA_ORIGINAL = [];                                                                                                     
      let DATA_FILTRADA = [];                                                                                                     
      let currentPage = 1;                                                                                                        
      let pageSize = 50;                                                                                                          
                                                                                                                                  
      const debounce = (fn, delay = 300) => {                                                                                     
        let t;                                                                                                                    
        return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };                                       
      };                                                                                                                          
                                                                                                                                  
      const PAISES = { 'CO': 'Colombia', 'PE': 'Per√∫' };                                                                          
                                                                                                                                  
      function toEpochMs(v) {                                                                                                     
        if (v === null || v === undefined || v === '' || v === 'NULL') return null;                                               
        let n = Number(v);                                                                                                        
        if (!Number.isFinite(n)) return null;                                                                                     
        if (n < 1e12) n = n * 1000;                                                                                               
        return n;                                                                                                                 
      }                                                                                                                           
                                                                                                                                  
      function formatearFechaHumana(v) {                                                                                          
        const ms = toEpochMs(v);                                                                                                  
        if (ms === null) return '';                                                                                               
        const d = new Date(ms);                                                                                                   
        if (isNaN(d.getTime())) return '';                                                                                        
        return new Intl.DateTimeFormat('es-CO', { day: 'numeric', month: 'long', year: 'numeric' }).format(d);                    
      }                                                                                                                           
                                                                                                                                  
      // Modal                                                                                                                    
      function abrirModal(mina = null) {                                                                                          
        const modal = document.getElementById('modalMina');                                                                       
        const titulo = document.getElementById('modalTitulo');                                                                    
        const form = document.getElementById('formMina');                                                                         
                                                                                                                                  
        form.reset();                                                                                                             
        document.getElementById('minaId').value = '';                                                                             
        document.getElementById('modoEdicion').value = 'false';                                                                   
                                                                                                                                  
        if (mina) {                                                                                                               
          titulo.textContent = 'Editar Mina';                                                                                     
          document.getElementById('minaId').value = mina.id;                                                                      
          document.getElementById('minaNombre').value = mina.nombre || '';                                                        
          document.getElementById('minaPais').value = mina.pais || '';                                                            
          document.getElementById('modoEdicion').value = 'true';                                                                  
        } else {                                                                                                                  
          titulo.textContent = 'Nueva Mina';                                                                                      
        }                                                                                                                         
                                                                                                                                  
        modal.classList.remove('hidden');                                                                                         
      }                                                                                                                           
                                                                                                                                  
      function cerrarModal() {                                                                                                    
        document.getElementById('modalMina').classList.add('hidden');                                                             
      }                                                                                                                           
                                                                                                                                  
      // Guardar mina                                                                                                             
      document.getElementById('formMina').addEventListener('submit', async function(e) {                                          
        e.preventDefault();                                                                                                       
                                                                                                                                  
        const id = document.getElementById('minaId').value;                                                                       
        const nombre = document.getElementById('minaNombre').value.trim();                                                        
        const pais = document.getElementById('minaPais').value;                                                                   
        const esEdicion = document.getElementById('modoEdicion').value === 'true';                                                
                                                                                                                                  
        if (!nombre || !pais) {                                                                                                   
          Swal.fire('Error', 'Complete todos los campos', 'error');                                                               
          return;                                                                                                                 
        }                                                                                                                         
                                                                                                                                  
        const action = esEdicion ? 'actualizar_mina' : 'guardar_mina';                                                            
        const datos = esEdicion                                                                                                   
          ? { action, id, name: nombre, country: pais }                                                                           
          : { action, name: nombre, country: pais };                                                                              
                                                                                                                                  
        Swal.fire({                                                                                                               
          title: esEdicion ? 'Actualizando...' : 'Guardando...',                                                                  
          allowOutsideClick: false,                                                                                               
          didOpen: () => Swal.showLoading(),                                                                                      
        });                                                                                                                       
                                                                                                                                  
        try {                                                                                                                     
          const res = await fetch(GAS_URL, {                                                                                      
            method: 'POST',                                                                                                       
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },                                                              
            body: JSON.stringify(datos),                                                                                          
          });                                                                                                                     
                                                                                                                                  
          const result = await res.json();                                                                                        
                                                                                                                                  
          if (result.success) {                                                                                                   
            Swal.fire({                                                                                                           
              title: esEdicion ? 'Mina actualizada' : 'Mina creada',                                                              
              icon: 'success',                                                                                                    
              confirmButtonColor: '#2563eb',                                                                                      
            });                                                                                                                   
            cerrarModal();                                                                                                        
            cargarMinas();                                                                                                        
          } else {                                                                                                                
            throw new Error(result.error || 'Error al guardar');                                                                  
          }                                                                                                                       
        } catch (err) {                                                                                                           
          Swal.fire('Error', err.message, 'error');                                                                               
        }                                                                                                                         
      });                                                                                                                         
                                                                                                                                  
      // Eliminar mina                                                                                                            
      async function eliminarMina(id, nombre) {                                                                                   
        const result = await Swal.fire({                                                                                          
          title: '¬øEliminar mina?',                                                                                               
          text: `Se eliminar√° "${nombre}"`,                                                                                       
          icon: 'warning',                                                                                                        
          showCancelButton: true,                                                                                                 
          confirmButtonColor: '#dc2626',                                                                                          
          cancelButtonColor: '#6b7280',                                                                                           
          confirmButtonText: 'S√≠, eliminar',                                                                                      
          cancelButtonText: 'Cancelar'                                                                                            
        });                                                                                                                       
                                                                                                                                  
        if (!result.isConfirmed) return;                                                                                          
                                                                                                                                  
        Swal.fire({                                                                                                               
          title: 'Eliminando...',                                                                                                 
          allowOutsideClick: false,                                                                                               
          didOpen: () => Swal.showLoading(),                                                                                      
        });                                                                                                                       
                                                                                                                                  
        try {                                                                                                                     
          const res = await fetch(GAS_URL, {                                                                                      
            method: 'POST',                                                                                                       
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },                                                              
            body: JSON.stringify({ action: 'eliminar_mina', id }),                                                                
          });                                                                                                                     
                                                                                                                                  
          const data = await res.json();                                                                                          
                                                                                                                                  
          if (data.success) {                                                                                                     
            Swal.fire('Eliminada', 'La mina ha sido eliminada', 'success');                                                       
            cargarMinas();                                                                                                        
          } else {                                                                                                                
            throw new Error(data.error || 'Error al eliminar');                                                                   
          }                                                                                                                       
        } catch (err) {                                                                                                           
          Swal.fire('Error', err.message, 'error');                                                                               
        }                                                                                                                         
      }                                                                                                                           
                                                                                                                                  
      // Render tabla                                                                                                             
      function renderTabla() {                                                                                                    
        const tbody = document.getElementById("tablaMinas");                                                                      
        tbody.innerHTML = "";                                                                                                     
                                                                                                                                  
        const total = DATA_FILTRADA.length;                                                                                       
        const totalPages = Math.max(1, Math.ceil(total / pageSize));                                                              
        if (currentPage > totalPages) currentPage = totalPages;                                                                   
                                                                                                                                  
        const startIdx = (currentPage - 1) * pageSize;                                                                            
        const endIdx = Math.min(startIdx + pageSize, total);                                                                      
        const slice = DATA_FILTRADA.slice(startIdx, endIdx);                                                                      
                                                                                                                                  
        if (!slice.length) {                                                                                                      
          tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">Sin resultados</td></tr>`;           
        } else {                                                                                                                  
          const filas = slice.map((m) => {                                                                                        
            const esEditable = m.source === 'web';                                                                                
            const paisNombre = PAISES[m.pais] || m.pais || '';                                                                    
                                                                                                                                  
            const acciones = esEditable                                                                                           
              ? `<div class="flex gap-2 justify-center">                                                                          
                  <button onclick='abrirModal(${JSON.stringify(m).replace(/'/g, "&#39;")})'                                       
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">Editar</button>                                 
                  <button onclick="eliminarMina('${m.id}', '${(m.nombre || '').replace(/'/g, "\\'")}')"                           
                    class="text-red-600 hover:text-red-800 text-sm font-medium">Eliminar</button>                                 
                </div>`                                                                                                           
              : `<span class="text-gray-400 text-sm">‚Äî</span>`;                                                                   
                                                                                                                                  
            return `                                                                                                              
              <tr class="border-t hover:bg-gray-50">                                                                              
                <td class="px-4 py-2">${m.nombre || ""}</td>                                                                      
                <td class="px-4 py-2">${m.categoria || ""}</td>                                                                   
                <td class="px-4 py-2">${paisNombre}</td>                                                                          
                <td class="px-4 py-2">${formatearFechaHumana(m.timestamp)}</td>                                                   
                <td class="px-4 py-2">${formatearFechaHumana(m.last_value)}</td>                                                  
                <td class="px-4 py-2">                                                                                            
                  <span class="px-2 py-1 rounded text-xs ${m.estado === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100   
  text-gray-600'}">                                                                                                               
                    ${m.estado || ""}                                                                                             
                  </span>                                                                                                         
                </td>                                                                                                             
                <td class="px-4 py-2 text-center">${acciones}</td>                                                                
              </tr>                                                                                                               
            `;                                                                                                                    
          }).join("");                                                                                                            
          tbody.innerHTML = filas;                                                                                                
        }                                                                                                                         
                                                                                                                                  
        document.getElementById("rangeInfo").textContent =                                                                        
          `Mostrando ${total ? (startIdx + 1) : 0}‚Äì${endIdx} de ${total}`;                                                        
                                                                                                                                  
        renderPaginacion(total, totalPages);                                                                                      
      }                                                                                                                           
                                                                                                                                  
      // Paginaci√≥n                                                                                                               
      function renderPaginacion(total, totalPages) {                                                                              
        const cont = document.getElementById("pagination");                                                                       
        cont.innerHTML = "";                                                                                                      
                                                                                                                                  
        const makeBtn = (label, onClick, disabled = false, active = false) => {                                                   
          const btn = document.createElement("button");                                                                           
          btn.type = "button";                                                                                                    
          btn.textContent = label;                                                                                                
          btn.className = `btn-page px-3 py-1 rounded border ${active ? 'bg-blue-600 text-white border-blue-600' : 'bg-white      
  text-gray-700 hover:bg-gray-50'}`;                                                                                              
          btn.disabled = disabled;                                                                                                
          btn.addEventListener("click", onClick);                                                                                 
          return btn;                                                                                                             
        };                                                                                                                        
                                                                                                                                  
        const totalPagesSafe = Math.max(1, totalPages);                                                                           
                                                                                                                                  
        cont.appendChild(makeBtn("¬´ Primera", () => { currentPage = 1; renderTabla(); }, currentPage === 1));                     
        cont.appendChild(makeBtn("‚Äπ Anterior", () => { currentPage = Math.max(1, currentPage - 1); renderTabla(); }, currentPage  
  === 1));                                                                                                                        
                                                                                                                                  
        const windowSize = 7;                                                                                                     
        let start = Math.max(1, currentPage - Math.floor(windowSize / 2));                                                        
        let end = Math.min(totalPagesSafe, start + windowSize - 1);                                                               
        if (end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);                                              
                                                                                                                                  
        if (start > 1) {                                                                                                          
          cont.appendChild(makeBtn("1", () => { currentPage = 1; renderTabla(); }, false, currentPage === 1));                    
          if (start > 2) {                                                                                                        
            const dots = document.createElement("span");                                                                          
            dots.textContent = "‚Ä¶";                                                                                               
            dots.className = "px-2 text-gray-500";                                                                                
            cont.appendChild(dots);                                                                                               
          }                                                                                                                       
        }                                                                                                                         
                                                                                                                                  
        for (let p = start; p <= end; p++) {                                                                                      
          cont.appendChild(makeBtn(String(p), () => { currentPage = p; renderTabla(); }, false, currentPage === p));              
        }                                                                                                                         
                                                                                                                                  
        if (end < totalPagesSafe) {                                                                                               
          if (end < totalPagesSafe - 1) {                                                                                         
            const dots2 = document.createElement("span");                                                                         
            dots2.textContent = "‚Ä¶";                                                                                              
            dots2.className = "px-2 text-gray-500";                                                                               
            cont.appendChild(dots2);                                                                                              
          }                                                                                                                       
          cont.appendChild(makeBtn(String(totalPagesSafe), () => { currentPage = totalPagesSafe; renderTabla(); }, false,         
  currentPage === totalPagesSafe));                                                                                               
        }                                                                                                                         
                                                                                                                                  
        cont.appendChild(makeBtn("Siguiente ‚Ä∫", () => { currentPage = Math.min(totalPagesSafe, currentPage + 1); renderTabla(); },
   currentPage === totalPagesSafe));                                                                                              
        cont.appendChild(makeBtn("√öltima ¬ª", () => { currentPage = totalPagesSafe; renderTabla(); }, currentPage ===              
  totalPagesSafe));                                                                                                               
      }                                                                                                                           
                                                                                                                                  
      // Filtro                                                                                                                   
      function aplicarFiltro(valor) {                                                                                             
        const v = (valor || "").toLowerCase().trim();                                                                             
        if (!v) {                                                                                                                 
          DATA_FILTRADA = [...DATA_ORIGINAL];                                                                                     
        } else {                                                                                                                  
          DATA_FILTRADA = DATA_ORIGINAL.filter((m) =>                                                                             
            Object.values(m).some((val) => String(val ?? "").toLowerCase().includes(v))                                           
          );                                                                                                                      
        }                                                                                                                         
        currentPage = 1;                                                                                                          
        renderTabla();                                                                                                            
      }                                                                                                                           
                                                                                                                                  
      // Cargar minas                                                                                                             
      async function cargarMinas() {                                                                                              
        const loader = document.getElementById("loader");                                                                         
        loader.style.display = "flex";                                                                                            
                                                                                                                                  
        try {                                                                                                                     
          const res = await fetch(GAS_URL, {                                                                                      
            method: "POST",                                                                                                       
            headers: { "Content-Type": "text/plain;charset=utf-8" },                                                              
            body: JSON.stringify({ action: "obtener_minas" })                                                                     
          });                                                                                                                     
                                                                                                                                  
          if (!res.ok) throw new Error("Fall√≥ la solicitud (" + res.status + ")");                                                
          const data = await res.json();                                                                                          
                                                                                                                                  
          if (data.success && Array.isArray(data.minas)) {                                                                        
            const minasUnicas = Object.values(                                                                                    
              data.minas.reduce((acc, mina) => {                                                                                  
                const nombreKey = (mina.nombre || "").trim().toLowerCase();                                                       
                const fechaActualMs = toEpochMs(mina.timestamp) ?? 0;                                                             
                const fechaGuardadaMs = toEpochMs(acc[nombreKey]?.timestamp) ?? 0;                                                
                if (!acc[nombreKey] || fechaActualMs > fechaGuardadaMs) {                                                         
                  acc[nombreKey] = mina;                                                                                          
                }                                                                                                                 
                return acc;                                                                                                       
              }, {})                                                                                                              
            );                                                                                                                    
                                                                                                                                  
            DATA_ORIGINAL = minasUnicas;                                                                                          
            DATA_FILTRADA = [...DATA_ORIGINAL];                                                                                   
            renderTabla();                                                                                                        
          } else {                                                                                                                
            throw new Error(data.error || "No se pudo obtener la lista de minas");                                                
          }                                                                                                                       
        } catch (err) {                                                                                                           
          console.error(err);                                                                                                     
          Swal.fire("Error", err.message, "error");                                                                               
        } finally {                                                                                                               
          loader.style.display = "none";                                                                                          
        }                                                                                                                         
      }                                                                                                                           
                                                                                                                                  
      // Event listeners                                                                                                          
      document.getElementById("btnAgregarMina").addEventListener("click", () => abrirModal());                                    
      document.getElementById("filtroGlobal").addEventListener("input", debounce((e) => aplicarFiltro(e.target.value), 250));     
      document.getElementById("pageSize").addEventListener("change", (e) => {                                                     
        pageSize = parseInt(e.target.value, 10) || 50;                                                                            
        currentPage = 1;                                                                                                          
        renderTabla();                                                                                                            
      });                                                                                                                         
                                                                                                                                  
      // Iniciar                                                                                                                  
      cargarMinas();                                                                                                              
    </script>                                                                                                                     
  </body>                                                                                                                         
                                                                                                                                  
  </html>