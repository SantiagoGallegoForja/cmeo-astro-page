---
// WhatsApp-styled floating button that opens a contact form widget
---

<!-- Container for button and form widget -->
<div id="whatsapp-widget-container" class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">

  <!-- Contact Form Widget (hidden by default) -->
  <div
    id="whatsapp-form-widget"
    class="hidden w-[340px] max-w-[calc(100vw-3rem)] bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden
           transform transition-all duration-300 origin-bottom-right scale-95 opacity-0"
  >
    <!-- Header -->
    <div class="relative bg-gradient-to-r from-[#25D366] to-[#128C7E] p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-white font-bold text-sm">Agenda tu cita</h3>
            <p class="text-white/80 text-xs">Te contactamos en 24h</p>
          </div>
        </div>
        <button
          id="whatsapp-close-btn"
          class="w-8 h-8 flex items-center justify-center rounded-full
                 text-white/80 hover:text-white hover:bg-white/20
                 transition-all duration-300"
          aria-label="Cerrar"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="p-4 max-h-[60vh] overflow-y-auto">
      <!-- Form -->
      <form id="whatsapp-contact-form" class="space-y-3">

        <!-- Nombre -->
        <div>
          <input
            type="text"
            name="nombre"
            placeholder="Tu nombre *"
            required
            autocomplete="name"
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 text-sm placeholder-gray-400
                   transition-all duration-300
                   hover:border-brand-green-300
                   focus:outline-none focus:border-brand-green-500 focus:bg-white focus:ring-2 focus:ring-brand-green-100"
          />
        </div>

        <!-- Correo -->
        <div>
          <input
            type="email"
            name="email"
            placeholder="Tu correo *"
            required
            autocomplete="email"
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 text-sm placeholder-gray-400
                   transition-all duration-300
                   hover:border-brand-green-300
                   focus:outline-none focus:border-brand-green-500 focus:bg-white focus:ring-2 focus:ring-brand-green-100"
          />
        </div>

        <!-- Celular -->
        <div class="flex gap-2">
          <select
            name="indicativo"
            class="appearance-none px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-600 text-sm cursor-pointer
                   hover:border-brand-green-300 focus:outline-none focus:border-brand-green-500 focus:bg-white
                   transition-all duration-300"
            style="min-width: 80px;"
          >
            <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
            <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
            <option value="+51">ðŸ‡µðŸ‡ª +51</option>
          </select>
          <input
            type="tel"
            name="telefono"
            placeholder="Celular"
            autocomplete="tel"
            class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 text-sm placeholder-gray-400
                   transition-all duration-300
                   hover:border-brand-green-300
                   focus:outline-none focus:border-brand-green-500 focus:bg-white focus:ring-2 focus:ring-brand-green-100"
          />
        </div>

        <!-- Especialidad -->
        <div>
          <select
            name="especialidad"
            required
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 text-sm appearance-none cursor-pointer
                   transition-all duration-300
                   hover:border-brand-green-300
                   focus:outline-none focus:border-brand-green-500 focus:bg-white focus:ring-2 focus:ring-brand-green-100
                   bg-no-repeat"
            style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%236b7280%27 stroke-width=%272%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 d=%27M19 9l-7 7-7-7%27/%3E%3C/svg%3E'); background-size: 1rem; background-position: right 0.75rem center;"
          >
            <option value="" disabled selected>Especialidad de interes *</option>
            <option value="Otorrinolaringologia">Otorrinolaringologia</option>
            <option value="Oftalmologia">Oftalmologia</option>
          </select>
        </div>

        <!-- Checkbox de terminos -->
        <div>
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="acepta_terminos"
              required
              class="mt-0.5 w-4 h-4 rounded border-2 border-gray-300 text-brand-green-500
                     focus:ring-2 focus:ring-brand-green-500/20
                     checked:bg-brand-green-500 checked:border-brand-green-500
                     transition-all duration-200 cursor-pointer accent-brand-green-500"
            />
            <span class="text-xs text-gray-500 leading-relaxed">
              Acepto la <a href="/politica-privacidad" target="_blank" class="text-brand-green-600 hover:underline">politica de datos</a>
            </span>
          </label>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          id="whatsapp-submit-btn"
          class="w-full px-4 py-3 bg-[#25D366] hover:bg-[#128C7E] text-white font-bold text-sm rounded-xl
                 shadow-lg hover:shadow-xl
                 transform hover:-translate-y-0.5 active:translate-y-0
                 transition-all duration-300
                 flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" data-button-icon fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          <span data-button-text>Enviar mensaje</span>
          <svg
            class="w-5 h-5 animate-spin hidden"
            data-loading-spinner
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
          </svg>
        </button>
      </form>

      <div id="whatsapp-status" class="hidden mt-3 p-3 rounded-xl text-sm font-medium" role="alert"></div>
    </div>
  </div>

  <!-- Floating WhatsApp Button -->
  <button
    id="whatsapp-contact-btn"
    class="whatsapp-button flex items-center gap-3 group"
    aria-label="Abrir formulario de contacto"
  >
    <!-- Tooltip -->
    <span class="hidden md:block bg-white text-gray-800 text-sm font-medium px-4 py-2 rounded-full shadow-lg
                 opacity-0 group-hover:opacity-100 translate-x-4 group-hover:translate-x-0
                 transition-all duration-300 whitespace-nowrap">
      Â¿Necesitas ayuda?
    </span>

    <!-- Button -->
    <span class="relative flex items-center justify-center w-16 h-16 rounded-full
                 bg-[#25D366] shadow-lg shadow-[#25D366]/30
                 hover:scale-110 hover:shadow-xl hover:shadow-[#25D366]/40
                 transition-all duration-300">
      <!-- Pulse animation -->
      <span class="absolute inset-0 rounded-full bg-[#25D366] animate-ping opacity-30"></span>

      <!-- WhatsApp Icon -->
      <svg id="whatsapp-icon" class="relative w-8 h-8 text-white transition-all duration-300" fill="currentColor" viewBox="0 0 24 24">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
      </svg>

      <!-- Close Icon (hidden by default) -->
      <svg id="close-icon" class="relative w-7 h-7 text-white hidden transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </span>
  </button>
</div>

<script>
  function initWhatsAppWidget() {
    const btn = document.getElementById('whatsapp-contact-btn');
    const widget = document.getElementById('whatsapp-form-widget');
    const closeBtn = document.getElementById('whatsapp-close-btn');
    const form = document.getElementById('whatsapp-contact-form') as HTMLFormElement;
    const status = document.getElementById('whatsapp-status');
    const submitBtn = document.getElementById('whatsapp-submit-btn');
    const buttonText = submitBtn?.querySelector('[data-button-text]');
    const buttonIcon = submitBtn?.querySelector('[data-button-icon]');
    const spinner = submitBtn?.querySelector('[data-loading-spinner]');
    const whatsappIcon = document.getElementById('whatsapp-icon');
    const closeIcon = document.getElementById('close-icon');

    if (!btn || !widget || !closeBtn || !form) return;

    let isOpen = false;

    const openWidget = () => {
      isOpen = true;
      widget.classList.remove('hidden');
      // Small delay for animation
      setTimeout(() => {
        widget.classList.remove('scale-95', 'opacity-0');
        widget.classList.add('scale-100', 'opacity-100');
      }, 10);
      whatsappIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
    };

    const closeWidget = () => {
      isOpen = false;
      widget.classList.add('scale-95', 'opacity-0');
      widget.classList.remove('scale-100', 'opacity-100');
      setTimeout(() => {
        widget.classList.add('hidden');
      }, 300);
      whatsappIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
      form.reset();
      status?.classList.add('hidden');
    };

    const toggleWidget = () => {
      if (isOpen) {
        closeWidget();
      } else {
        openWidget();
      }
    };

    // Expose globally
    (window as any).openContactForm = openWidget;
    (window as any).closeContactForm = closeWidget;

    btn.addEventListener('click', toggleWidget);
    closeBtn.addEventListener('click', closeWidget);

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) closeWidget();
    });

    // Get UTM params
    const getUtmParams = () => {
      const params = new URLSearchParams(window.location.search);
      return {
        utm_source: params.get('utm_source') || '',
        utm_medium: params.get('utm_medium') || '',
        utm_campaign: params.get('utm_campaign') || '',
        utm_term: params.get('utm_term') || '',
        utm_content: params.get('utm_content') || '',
        gclid: params.get('gclid') || '',
        fclid: params.get('fclid') || ''
      };
    };

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      const utmParams = getUtmParams();

      submitBtn?.setAttribute('disabled', 'true');
      buttonText?.classList.add('hidden');
      buttonIcon?.classList.add('hidden');
      spinner?.classList.remove('hidden');

      try {
        const response = await fetch('https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjYwNTZkMDYzNDA0MzY1MjY5NTUzNjUxMzci_pc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Name: data.nombre,
            Email: data.email,
            Indicativo: data.indicativo,
            Telefono: data.telefono,
            Especialidad: data.especialidad,
            'Service Type': 'Widget WhatsApp',
            Origin: 'cmeo.com.co',
            'Utm Source': utmParams.utm_source,
            'Utm Medium': utmParams.utm_medium,
            'Utm Campaign': utmParams.utm_campaign,
            'Utm Term': utmParams.utm_term,
            'Utm Content': utmParams.utm_content,
            Gclid: utmParams.gclid,
            Fclid: utmParams.fclid
          })
        });

        if (response.ok) {
          if (status) {
            status.innerHTML = `
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-brand-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Enviado. Te contactaremos pronto.</span>
              </div>
            `;
            status.className = 'mt-3 p-3 rounded-xl text-sm font-medium bg-brand-green-50 text-brand-green-800 border border-brand-green-200';
            status.classList.remove('hidden');
          }

          // GTM event
          if ((window as any).dataLayer) {
            (window as any).dataLayer.push({
              event: 'wpforms_submit',
              'attributes.response.data': 'wpforms-confirmation',
              formName: 'Widget WhatsApp',
              pagePath: window.location.pathname
            });
          }

          form.reset();
          // Redirect to WhatsApp after 1.5 seconds
          setTimeout(() => {
            window.location.href = 'https://wa.me/573224148773';
          }, 1500);
        } else {
          throw new Error('Server error');
        }
      } catch (error) {
        if (status) {
          status.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Error. Intenta de nuevo.</span>
            </div>
          `;
          status.className = 'mt-3 p-3 rounded-xl text-sm font-medium bg-red-50 text-red-800 border border-red-200';
          status.classList.remove('hidden');
        }
      } finally {
        submitBtn?.removeAttribute('disabled');
        buttonText?.classList.remove('hidden');
        buttonIcon?.classList.remove('hidden');
        spinner?.classList.add('hidden');
      }
    });
  }

  initWhatsAppWidget();
  document.addEventListener('astro:page-load', initWhatsAppWidget);
</script>
