---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import WhatsAppButton from '../components/ui/WhatsAppButton.astro';
import ContactModal from '../components/forms/ContactModal.astro';

interface Props {
  title: string;
  description?: string;
  showFloatingWidget?: boolean;
}

const { title, description, showFloatingWidget = false } = Astro.props;
const currentPath = Astro.url.pathname;
---

<BaseLayout title={title} description={description}>
  <Header currentPath={currentPath} />

  <main id="main-content">
    <slot />
  </main>

  <Footer />

  <!-- WhatsApp floating button on all pages -->
  <WhatsAppButton />

  <!-- Contact Modal for "Agendar cita" buttons -->
  <ContactModal />

  {showFloatingWidget && (
    <slot name="floating-widget" />
  )}

  <!-- Smooth scroll animation for anchor links -->
  <script>
    function initSmoothScroll() {
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
          const href = this.getAttribute('href');
          if (!href || href === '#') return;

          const target = document.querySelector(href);
          if (target) {
            e.preventDefault();
            const targetPosition = target.getBoundingClientRect().top + window.pageYOffset;
            const startPosition = window.pageYOffset;
            const distance = targetPosition - startPosition - 80; // 80px offset for header
            const duration = 800; // ms
            let start: number | null = null;

            function easeInOutCubic(t: number): number {
              return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }

            function animation(currentTime: number) {
              if (start === null) start = currentTime;
              const timeElapsed = currentTime - start;
              const progress = Math.min(timeElapsed / duration, 1);
              const ease = easeInOutCubic(progress);

              window.scrollTo(0, startPosition + distance * ease);

              if (timeElapsed < duration) {
                requestAnimationFrame(animation);
              }
            }

            requestAnimationFrame(animation);
          }
        });
      });
    }

    initSmoothScroll();
    document.addEventListener('astro:page-load', initSmoothScroll);
  </script>
</BaseLayout>
